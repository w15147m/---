import { db } from './client';
import { events, chapters, articles, items, article_event } from './schema';

export const seedDatabase = async () => {
  try {
    // Check if we already have data
    const existingChapters = await db.select().from(chapters).limit(1);
    if (existingChapters.length > 0) {
      console.log('🌱 Database already seeded, skipping...');
      return;
    }

    console.log('🌱 Seeding database...');

    // Wipe existing data to ensure a fresh start
    const { sql } = require('drizzle-orm');
    await db.run(sql`DELETE FROM article_event`);
    await db.run(sql`DELETE FROM items`);
    await db.run(sql`DELETE FROM articles`);
    await db.run(sql`DELETE FROM chapters`);
    await db.run(sql`DELETE FROM events`);

    console.log('🧹 Existing data cleared.');

    // --- TAQEEBAT SECTION ---

    // 1. Create Main Taqeebat Chapter
    await db.insert(chapters).values({
      name: 'تعقیباتِ نماز (Taqeebat-e-Namaz)',
      thumbnail_url: 'https://example.com/taqeebat.png',
    });

    const [taqeebatChapter] = await db.select().from(chapters)
      .where(require('drizzle-orm').eq(chapters.name, 'تعقیباتِ نماز (Taqeebat-e-Namaz)'))
      .limit(1);

    // 2. Create Sub-Chapters (Specific / General)
    await db.insert(chapters).values([
      {
        name: 'دعا بعد از نماز (Specific)',
        parent_id: taqeebatChapter.id,
      },
      {
        name: 'دیگر دعائیں (General)',
        parent_id: taqeebatChapter.id,
      }
    ]);

    const subChapters = await db.select().from(chapters)
      .where(require('drizzle-orm').eq(chapters.parent_id, taqeebatChapter.id));

    const specificSub = subChapters.find(s => s.name.includes('Specific'));
    const generalSub = subChapters.find(s => s.name.includes('General'));

    // 3. Insert Specific Taqeebat Articles & Items
    if (specificSub) {
      const specificPrayers = [
        {
          title_ar: 'دعائے  نمازِ فجر', title_en: 'Fajr Prayer',
          text: 'اَللّٰهُمَّ اِنِّی اَسْئَلُكَ بِحَقِّ مُحَمَّدٍ وَّ آلِ مُحَمَّدٍ عَلَیْكَ صَلِّ عَلٰی مُحَمَّدٍ وَّ آلِ مُحَمَّدٍ وَّاجْعَلِ النُّورَ فِی بَصَرِی وَالْبَصِیرَةَ فِی دِینِی وَالْیَقِینَ فِی قَلْبِی وَالْاِخْلَاصَ فِی عَمَلِی وَالسَّلَامَةَ فِی نَفْسِی وَالسَّعَةَ فِی رِزْقِی وَالشُّكْرَ لَكَ اَبَدًا مَّا اَبْقَیْتَنِی. اَسْتَغْفِرُ اللهَ الَّذِی لَا اِلٰهَ اِلَّا هُوَ الْحَیُّ الْقَیُّومُ وَ اَتُوبُ اِلَیْهِ اَللّٰهُمَّ اهْدِنِی مِنْ عِنْدِكَ وَ اَفِضْ عَلَیَّ مِنْ فَضْلِكَ وَانْشُرْ عَلَیَّ مِنْ رَّحْمَتِكَ وَ اَنْزِلْ عَلَیَّ مِنْ بَرَكَاتِكَ سُبْحَانَكَ لَا اِلٰهَ اِلَّا اَنْتَ اِغْفِرْ لِی ذُنُوبِی کُلَّهَا جَمِیعًا فَاِنَّهٗ لَا یَغْفِرُ الذُّنُوبَ کُلَّهَا جَمِیعًا اِلَّا اَنْتَ. اَللّٰهُمَّ اِنِّی اَسْئَلُكَ مِنْ كُلِّ خَیْرٍ اَحَاطَ بِهٖ عِلْمُكَ وَ اَعُوذُ بِكَ مِنْ كُلِّ شَرٍّ اَحَاطَ بِهٖ عِلْمُكَ اَللّٰهُمَّ اِنِّی اَسْئَلُكَ عَافِیَتَكَ فِی اُمُورِی کُلِّهَا وَ اَعُوذُ بِكَ مِنْ خِزْیِ الدُّنْیَا وَ عَذَابِ الْاٰخِرَةِ وَ اَعُوذُ بِوَجْهِكَ الْکَرِیمِ وَ عِزَّتِكَ الَّتِی لَا تُرَامُ وَ قُدْرَتِكَ الَّتِی لَا یَمْتَنِعُ مِنْهَا شَیْئٌ مِنْ شَرِّ الدُّنْیَا وَ الْاٰخِرَةِ وَ مِنْ شَرِّ الْاَوْجَاعِ کُلِّهَا وَ مِنْ شَرِّ كُلِّ دَابَّةٍ اَنْتَ اٰخِذٌ بِنَاصِیَتِهَا اِنَّ رَبِّی عَلٰی صِرَاطٍ مُّسْتَقِیمٍ وَ لَا حَوْلَ وَ لَا قُوَّةَ اِلَّا بِاللهِ الْعَلِیِّ الْعَظِیمِ تَوَکَّلْتُ عَلَی الْحَیِّ الَّذِی لَا یَمُوتُ وَالْحَمْدُ لِلَّهِ الَّذِی لَمْ یَتَّخِذْ وَلَدًا وَ لَمْ یَکُنْ لَّهٗ شَرِیكٌ فِی الْمُلْكِ وَ لَمْ یَکُنْ لَّهٗ وَلِیٌّ مِّنَ الذُّلِّ وَ کَبِّرْهُ تَكْبِیرًا.'
        },
        {
          title_ar: 'دعائے  نمازِ ظہر', title_en: 'Dhuhr Prayer',
          text: 'لَا اِلٰهَ اِلَّا اللهُ الْعَظِیمُ الْحَلِیمُ لَا اِلٰهَ اِلَّا اللهُ رَبُّ الْعَرْشِ الْکَرِیمِ اَلْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِینَ اَللّٰهُمَّ اِنِّی اَسْئَلُكَ مُوجِبَاتِ رَحْمَتِكَ وَ عَزَائِمَ مَغْفِرَتِكَ وَالْغَنِیمَةَ مِنْ كُلِّ بِرٍّ وَالسَّلَامَةَ مِنْ كُلِّ اِثْمٍ اَللّٰهُمَّ لَا تَدَعْ لِی ذَنْبًا اِلَّا غَفَرْتَهٗ وَ لَا هَمًّا اِلَّا فَرَّجْتَهٗ وَ لَا سُقْمًا اِلَّا شَفَیْتَهٗ وَ لَا عَیْبًا اِلَّا سَتَرْتَهٗ وَ لَا رِزْقًا اِلَّا بَسَطْتَهٗ وَ لَا خَوْفًا اِلَّا اٰمَنْتَهٗ وَ لَا سُوءً اِلَّا صَرَفْتَهٗ وَ لَا حَاجَةً هِیَ لَكَ رِضًا وَّلِیَ فِیهَا صَلَاحٌ اِلَّا قَضَیْتَهَا یَا اَرْحَمَ الرَّاحِمِینَ اٰمِینَ رَبَّ الْعَالَمِینَ.'
        },
        {
          title_ar: 'دعائے  نمازِ عصر', title_en: 'Asr Prayer',
          text: 'اَسْتَغْفِرُ اللهَ الَّذِی لَا اِلٰهَ اِلَّا هُوَ الْحَیُّ الْقَیُّومُ الرَّحْمٰنُ الرَّحِیمُ ذُوالْجَلَالِ وَالْاِكْرَامِ وَ اَسْئَلُهٗ اَنْ یَّتُوبَ عَلَیَّ تَوْبَةَ عَبْدٍ ذَلِیلٍ خَاضِعٍ فَقِیرٍ بَائِسٍ مِسْکِینٍ مُسْتَکِینٍ مُسْتَجِیرٍ لَا یَمْلِكُ لِنَفْسِهٖ نَفْعًا وَّلَا ضَرًّا وَّلَا مَوْتًا وَّلَا حَیَاةً وَّلَا نُشُورًا. اَللّٰهُمَّ اِنِّی اَعُوذُ بِكَ مِنْ نَفْسٍ لَّا تَشْبَعُ وَ مِنْ قَلْبٍ لَّا یَخْشَعُ وَ مِنْ عِلْمٍ لَّا یَنْفَعُ وَ مِنْ صَلٰوةٍ لَا تُرْفَعُ وَ مِنْ دُعَاءٍ لَا یُسْمَعُ اَللّٰهُمَّ اِنِّی اَسْئَلُكَ الْیُسْرَ بَعْدَ الْعُسْرِ وَالْفَرَجَ بَعْدَ الْکَرْبِ وَ الرَّخَاءَ بَعْدَ الشِّدَّةِ اَللّٰهُمَّ مَا بِنَا مِنْ نِّعْمَةٍ فَمِنْكَ لَا اِلٰهَ اِلَّا اَنْتَ اَسْتَغْفِرُكَ وَ اَتُوبُ اِلَیْكَ.'
        },
        {
          title_ar: 'دعائے  نمازِ مغرب', title_en: 'Maghrib Prayer',
          text: 'اَللّٰهُمَّ اِنِّی اَسْئَلُكَ مُوجِبَاتِ رَحْمَتِكَ وَ عَزَائِمَ مَغْفِرَتِكَ وَالنَّجَاةَ مِنَ النَّارِ وَ مِنْ كُلِّ بَلِیَّةٍ وَالْفَوْزَ بِالْجَنَّةِ وَالرِّضْوَانَ فِی دَارِ السَّلَامِ وَ جِوَارِ نَبِیِّكَ مُحَمَّدٍ صَلَّی اللهُ عَلَیْهِ وَ اٰلِهٖ وَ سَلَّمَ اَللّٰهُمَّ مَا بِنَا مِنْ نِّعْمَةٍ فَمِنْكَ لَا اِلٰهَ اِلَّا اَنْتَ اَسْتَغْفِرُكَ وَ اَتُوبُ اِلَیْكَ. یَا مَنْ لَا یَشْغَلُهٗ سَمْعٌ عَنْ سَمْعٍ وَ یَا مَنْ لَا یُغَلِّطُهٗ السَّائِلُونَ وَ یَا مَنْ لَا یُبْرِمُهٗ اِلْحَاحُ الْمُلِحِّینَ اَذِقْنِی بَرْدَ عَفْوِكَ وَ حَلَاوَةَ رَحْمَتِكَ وَ مَغْفِرَتِكَ اِلٰهِی هٰذِهٖ صَلَاتِی صَلَّیْتُهَا لَا لِحَاجَةٍ مِنْكَ اِلَیْهَا وَ لَا رَغْبَةٍ مِنْكَ فِیهَا اِلَّا تَعْظِیمًا وَّ طَاعَةً وَّ اِجَابَةً لَّكَ اِلٰی مَا اَمَرْتَنِی بِهٖ اِلٰهِی اِنْ کَانَ فِیهَا خَلَلٌ اَوْ نَقْصٌ مِنْ رُکُوعِهَا اَوْ سُجُودِهَا فَلَا تُؤَاخِذْنِی وَ تَفَضَّلْ عَلَیَّ بِفَضْلِكَ اِنَّكَ ذُو فَضْلٍ عَظِیمٍ.'
        }
      ];

      for (const prayer of specificPrayers) {
        await db.insert(articles).values({
          chapter_id: specificSub.id,
          title_ar: prayer.title_ar,
          title_en: prayer.title_en,
        });

        const [article] = await db.select().from(articles)
          .where(require('drizzle-orm').eq(articles.title_en, prayer.title_en))
          .limit(1);

        await db.insert(items).values({
          article_id: article.id,
          sequence_order: 1,
          arabic_text: prayer.text,
        });
      }
    }

    // 4. Insert General Taqeebat Articles & Items
    if (generalSub) {
      const generalPrayers = [
        {
          title_ar: 'آیت الکرسی', title_en: 'Ayat Al-Kursi',
          text: 'بِسْمِ اللهِ الرَّحْمٰنِ الرَّحِيْمِ اللَّهُ لَا إِلٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ ۚ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ ۚ لَّهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ ۗ مَن ذَا الَّذِي يَشْفَعُ عِندَهُ إِلَّا بِإِذْنِهِ ۚ يَعْلَمُ مَا بَيْنَ اَيْدِیهِمْ وَمَا خَلْفَهُمْ ۖ وَلَا يُحِيطُونَ بِشَيْءٍ مِّنْ عِلْمِهِ إِلَّا بِمَا شَاءَ ۚ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ ۖ وَلَا يَئُودُهُ حِفْظُهُمَا ۚ وَهُوَ الْعَلِيُّ الْعَظِيمُ. لَا إِكْرَاهَ فِي الدِّينِ ۖ قَد تَّبَيَّنَ الرُّشْدُ مِنَ الْغَيِّ ۚ فَمَن يَكْفُرْ بِالطَّاغُوتِ وَيُؤْمِن بِاللَّهِ فَقَدِ اسْتَمْسَكَ بِالْعُرْوَةِ الْوُثْقَىٰ لَا انفِصَامَ لَهَا ۗ وَاللَّهُ سَمِيعٌ عَلِيمٌ. اللَّهُ وَلِيُّ الَّذِينَ آمَنُوا يُخْرِجُهُم مِّنَ الظُّلُمَاتِ إِلَى النُّورِ ۖ وَالَّذِينَ كَفَرُوا اَوْلِیَاؤُهُمُ الطَّاغُوتُ يُخْرِجُونَهُم مِّنَ النورِ إِلَى الظُّلُمَاتِ ۗ اُولٰئِكَ أَصْحَابُ النَّارِ ۖ هُمْ فِيهَا خَالِدُونَ.'
        },
        {
          title_ar: 'دعائے جامع', title_en: 'Dua-e-Jami',
          text: 'اَللّٰهُمَّ ارْزُقْنَا تَوْفِیقَ الطَّاعَةِ وَ بُعْدَ الْمَعْصِیَةِ وَ صِدْقَ النِّیَّةِ وَ عِرْفَانَ الْحُرْمَةِ وَ اَکْرِمْنَا بِالْهُدٰی وَال|اِسْتِقَامَةِ وَ سَدِّدْ اَلْسِنَتَنَا بِالصَّوَابِ وَالْحِکْمَةِ وَامْلَاْ قُلُوبَنَا بِالْعِلْمِ وَالْمَعْرِفَةِ وَ طَهِّرْ بُطُونَنَا مِنَ الْحَرَامِ وَالشُّبْهَةِ وَ اکْفُفْ اَیْدِیَنَا عَنِ الظُّلْمِ وَالسَّرِقَةِ وَاغْضُض| اَبْصَارَنَا عَنِ الْفُجُورِ وَال|خِیَانَةِ وَاسْدُد| اَسْمَاعَنَا عَنِ اللَّغْوِ وَالْغِیْبَةِ وَ تَفَضَّلْ عَلٰی عُلَمَائِنَا بِالزُّهْدِ وَالنَّصِیحَةِ وَ عَلَی الْمُتَعَلِّمِینَ بِالْجُهْدِ وَال|رَّغْبَةِ وَ عَلَی الْمُسْتَمِعِینَ بِال|اِتِّبَاعِ وَالْمَوْعِظَةِ وَ عَلٰی مَرْضَی الْمُسْلِمِینَ بِالشِّفَاءِ وَالرَّاحَةِ وَ عَلٰی مَوْتَاهُمْ بِالرَّاْفَةِ وَالرَّحْمَةِ وَ عَلٰی مَشَایِخِنَا بِالْوَقَارِ وَالسَّکِینَةِ وَ عَلَی الشَّبَابِ بِال|اِنَابَةِ وَ التَّوْبَةِ وَ عَلَی النِّسَاءِ بِالْحَیَاءِ وَالْعِفَّةِ وَ عَلَی الْاَغْنِیَاءِ بِالتَّوَاضُعِ وَالسَّعَةِ وَ عَلَی الْاِمَرَاءِ بِالْعَدْلِ وَالشَّفَقَةِ وَ عَلَی الرَّعِیَّةِ بِال|اِنْصَافِ وَ حُسْنِ السِّیرَةِ وَ بَارِكْ لِلْحُجَّاجِ وَالزُّوَّارِ فِی الزَّادِ وَالنَّفَقَةِ وَاقْضِ مَا اَوْجَبْتَ عَلَیْهِمْ مِنَ الْحَجِّ وَالْعُمْرَةِ بِفَضْلِكَ وَ رَحْمَتِكَ یَا اَرْحَمَ الرَّاحِمِینَ.'
        },
        {
          title_ar: 'دعائے ماہِ رمضان', title_en: 'Dua-e-Mahe-Ramadan',
          text: 'یَا عَلِیُّ یَا عَظِیمُ یَا غَفُورُ یَا رَحِیمُ اَنْتَ الرَّبُّ الْعَظِیمُ الَّذِی لَیْسَ کَمِثْلِهٖ شَیْئٌ وَّ هُوَ السَّمِیعُ الْبَصِیرُ وَ هٰذَا شَهْرٌ عَظَّمْتَهٗ وَ کَرَّمْتَهٗ وَ شَرَّفْتَهٗ وَ فَضَّلْتَهٗ عَلَی الشُّهُورِ وَ هُوَ الشَّهْرُ الَّذِی فَرَضْتَ صِیَامَهٗ عَلَیَّ وَ هُوَ شَهْرُ رَمَضَانَ الَّذِی اَنْزَلْتَ فِیهِ الْقُرْاٰنَ هُدًى لِّلنَّاسِ وَ بَیِّنَاتٍ مِّنَ الْهُدٰی وَالْفُرْقَانِ وَ جَعَلْتَ فِیهِ لَیْلَةَ الْقَدْرِ وَ جَعَلْتَهَا خَیْرًا مِّنْ اَلْفِ شَهْرٍ فَیَا ذَا الْمَنِّ وَ لَا یُمَنُّ عَلَیْكَ مُنَّ عَلَیَّ بِفَکَاكِ رَقَبَتِی مِنَ النَّارِ فِیمَنْ تَمُنُّ عَلَیْهِ وَ اَدْخِل|نِی الْجَنَّةَ بِرَحْمَتِكَ یَا اَرْحَمَ الرَّاحِمِینَ.'
        },
        {
          title_ar: 'دعا برائے امامِ زمانہ', title_en: 'Dua Imam Zamana',
          text: 'اَللّٰهُمَّ کُنْ لِوَلِیِّكَ الْحُجَّةِ ابْنِ الْحَسَنِ صَلَواتُكَ عَلَیْهِ وَ عَلٰی اٰبَائِهٖ فِی هٰذِهٖ السَّاعَةِ وَ فِی كُلِّ سَاعَةٍ وَلِیًّا وَّ حَافِظًا وَّ قَائِدًا وَّ نَاصِرًا وَّ دَلِیلًا وَّ عَیْنًا حَتّٰی تُسْکِنَهٗ اَرْضَكَ طَوْعًا وَّ تُمَتِّعَهٗ فِیهَا طَوِیلاً.'
        }
      ];

      for (const prayer of generalPrayers) {
        await db.insert(articles).values({
          chapter_id: generalSub.id,
          title_ar: prayer.title_ar,
          title_en: prayer.title_en,
        });

        const [article] = await db.select().from(articles)
          .where(require('drizzle-orm').eq(articles.title_en, prayer.title_en))
          .limit(1);

        await db.insert(items).values({
          article_id: article.id,
          sequence_order: 1,
          arabic_text: prayer.text,
        });
      }
    }

    // --- EVENTS SECTION ---

    // 5. Create an Event
    await db.insert(events).values({
      name: 'شبِ قدر (Shab-e-Qadr)',
      details: 'The night of power in the month of Ramadan',
    });

    const [event] = await db.select().from(events)
      .where(require('drizzle-orm').eq(events.name, 'شبِ قدر (Shab-e-Qadr)'))
      .limit(1);

    // 6. Link Ramadan Article to Event
    const [ramadanArticle] = await db.select().from(articles)
      .where(require('drizzle-orm').eq(articles.title_en, 'Dua-e-Mahe-Ramadan'))
      .limit(1);

    if (ramadanArticle) {
      await db.insert(article_event).values({
        article_id: ramadanArticle.id,
        event_id: event.id,
      });
    }

    console.log('✅ Seeding completed!');
  } catch (error) {
    console.error('❌ Seeding failed:', error);
    throw error;
  }
};
